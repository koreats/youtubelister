<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유튜브 영상 텍스트 추출기</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-3xl">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">유튜브 영상 텍스트 추출기</h1>

        <!-- 입력 폼 -->
        <div class="space-y-4">
            <div>
                <label for="channel-input" class="block text-sm font-medium text-gray-700 mb-1">채널 URL 또는 ID</label>
                <input type="text" id="channel-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="채널의 전체 URL 또는 ID를 입력하세요">
            </div>

        </div>

        <!-- 영상 목록 조회 버튼 -->
        <div class="mt-6">
            <button id="fetch-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                영상 목록 조회
            </button>
        </div>

        <!-- 상태 메시지가 표시될 컨테이너 -->
        <div id="status-container" class="mt-4 text-center"></div>

        <!-- 영상 목록이 표시될 컨테이너 -->
        <div id="video-list-container" class="mt-8">
            <!-- 동적 콘텐츠가 여기에 삽입됩니다 -->
        </div>

        <!-- 텍스트 추출 버튼 -->
        <div class="mt-6">
            <button id="transcribe-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                선택한 영상 텍스트 추출
            </button>
        </div>

        <!-- 결과가 표시될 컨테이너 -->
        <div id="results-container" class="mt-8 p-4 border border-gray-200 rounded-md bg-gray-50 min-h-[100px]">
            <!-- 추출된 텍스트가 여기에 표시됩니다 -->
        </div>

    </div>

    <script>
        const channelInput = document.getElementById('channel-input');
        const fetchBtn = document.getElementById('fetch-btn');
        const videoListContainer = document.getElementById('video-list-container');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');

        let allTranscribedData = []; // Store full transcription data

        // 1. 영상 목록 조회 기능
        fetchBtn.addEventListener('click', async () => {
            const channelUrl = channelInput.value.trim();
            // API 키는 코드에 하드코딩되어 있음

            if (!channelUrl) {
                showStatus('채널 URL을 입력해주세요.', 'error');
                return;
            }

            showStatus('영상 목록을 가져오는 중입니다...', 'loading');
            fetchBtn.disabled = true;
            fetchBtn.textContent = '조회 중...';
            videoListContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            transcribeBtn.classList.add('hidden');

            try {
                const response = await fetch('/fetch-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel_url: channelUrl, api_key: "AIzaSyDnKP4KUcareg3DCHMu5T07FsG3KOf-5Dw" })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '알 수 없는 오류가 발생했습니다.');
                }
                
                videoData = data.videos; // 전체 비디오 데이터 저장
                displayVideoTable(videoData);
                showStatus(`총 ${videoData.length}개의 영상을 찾았습니다.`, 'success');

            } catch (error) {
                showStatus(error.message, 'error');
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = '영상 목록 조회';
            }
        });

        // 2. 텍스트 추출 기능
        transcribeBtn.addEventListener('click', async () => {
            const checkedCheckboxes = document.querySelectorAll('.video-checkbox:checked');
            
            if (checkedCheckboxes.length === 0) {
                showStatus('텍스트를 추출할 영상을 하나 이상 선택해주세요.', 'error');
                return;
            }

            // URL뿐만 아니라 필요한 메타데이터를 함께 전송
            const videosToTranscribe = Array.from(checkedCheckboxes).map(checkbox => {
                const videoId = checkbox.value;
                return videoData.find(v => v.videoId === videoId);
            });

            showStatus(`${videosToTranscribe.length}개 영상 처리 중... 잠시만 기다려주세요.`, 'loading');
            resultsContainer.innerHTML = '<p>로딩 중...</p>';
            transcribeBtn.disabled = true;
            transcribeBtn.textContent = '처리 중...';

            try {
                // 서버에는 URL만 전송
                const urlsToTranscribe = videosToTranscribe.map(v => v.url);
                const response = await fetch('/transcribe_multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urlsToTranscribe })
                });

                const results = await response.json();

                if (!response.ok) {
                    throw new Error(results.error || '텍스트 추출 중 오류가 발생했습니다.');
                }

                // 서버에서 받은 결과와 프론트에서 보낸 메타데이터를 합침
                allTranscribedData = results.results.map((result, index) => {
                    return {
                        ...result,
                        number: videosToTranscribe[index].number, // 넘버링 추가
                        publishedAt: videosToTranscribe[index].publishedAt // 업로드일 추가
                    };
                });

                displayTranscriptionResults(allTranscribedData);
                showStatus('텍스트 추출이 완료되었습니다.', 'success');

            } catch (error) {
                showStatus(error.message, 'error');
            } finally {
                transcribeBtn.disabled = false;
                transcribeBtn.textContent = '선택한 영상 텍스트 추출';
            }
        });

        function displayVideoTable(videos) {
            if (videos.length === 0) {
                videoListContainer.innerHTML = '<p class="text-center text-gray-500">표시할 영상이 없습니다.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';

            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                        <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300">
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제목</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">영상 길이</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">업로드일</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">동작</th>
                    </tr>
                </thead>
            `;

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';

            videos.forEach((video, index) => {
                video.number = index + 1; // 데이터에 넘버링 추가
                const tr = document.createElement('tr');
                const publishedDate = new Date(video.publishedAt).toISOString().split('T')[0];
                tr.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${video.number}</td>
                    <td class="px-2 py-4 whitespace-nowrap">
                        <input type="checkbox" class="video-checkbox rounded border-gray-300" value="${video.videoId}">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${video.title}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${video.duration}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${publishedDate}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="copy-url-btn text-indigo-600 hover:text-indigo-900" data-url="${video.url}">URL 복사</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            videoListContainer.innerHTML = '';
            videoListContainer.appendChild(table);

            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                document.querySelectorAll('.video-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // URL 복사 버튼에 이벤트 리스너 추가
            document.querySelectorAll('.copy-url-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const url = e.target.getAttribute('data-url');
                    navigator.clipboard.writeText(url).then(() => {
                        const originalText = e.target.textContent;
                        e.target.textContent = '복사됨!';
                        setTimeout(() => { e.target.textContent = originalText; }, 2000);
                    });
                });
            });

            transcribeBtn.classList.remove('hidden');
        }

        function displayTranscriptionResults(results) {
            resultsContainer.innerHTML = '';
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<p>추출된 텍스트가 없습니다.</p>';
                return;
            }

            results.forEach(result => {
                const details = document.createElement('details');
                details.className = 'bg-white shadow rounded-md mb-2';
                details.setAttribute('data-number', result.number);
                details.setAttribute('data-published', new Date(result.publishedAt).toISOString().split('T')[0]);

                const summary = document.createElement('summary');
                summary.className = 'font-semibold p-4 cursor-pointer';
                summary.textContent = `${result.number}. ${result.title}`;

                const content = document.createElement('div');
                content.className = 'p-4 border-t border-gray-200 whitespace-pre-wrap';
                content.textContent = result.transcript || '추출된 텍스트가 없습니다.';

                details.appendChild(summary);
                details.appendChild(content);
                resultsContainer.appendChild(details);
            });
            
            addResultActionButtons();
        }
        
        function addResultActionButtons() {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-4 flex space-x-2';

            const copyBtn = document.createElement('button');
            copyBtn.id = 'copy-markdown-btn';
            copyBtn.textContent = '전체 마크다운 복사';
            copyBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700';

            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'download-markdown-btn';
            downloadBtn.textContent = '전체 다운로드 (.md)';
            downloadBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700';

            buttonContainer.appendChild(copyBtn);
            buttonContainer.appendChild(downloadBtn);
            resultsContainer.appendChild(buttonContainer);

            copyBtn.addEventListener('click', copyAllAsMarkdown);
            downloadBtn.addEventListener('click', downloadAllAsMarkdown);
        }

        function generateResultsMarkdown() {
            return allTranscribedData.map(result => {
                const publishedDate = new Date(result.publishedAt).toISOString().split('T')[0];
                return `## ${result.number}. ${result.title}\n**업로드일:** ${publishedDate}\n\n${result.transcript}`;
            }).join('\n\n---\n\n');
        }

        function copyAllAsMarkdown() {
            const markdownContent = generateResultsMarkdown();
            navigator.clipboard.writeText(markdownContent).then(() => {
                showStatus('클립보드에 복사되었습니다.', 'success');
            }, () => {
                showStatus('복사에 실패했습니다.', 'error');
            });
        }

        function downloadAllAsMarkdown() {
            const markdownContent = generateResultsMarkdown();
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcripts.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showStatus(message, type) {
            statusContainer.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = message;
            if (type === 'error') {
                p.className = 'text-red-500';
            } else if (type === 'success') {
                p.className = 'text-green-500';
            } else {
                p.className = 'text-gray-500';
            }
            statusContainer.appendChild(p);
        }

    </script>
</body>
</html>