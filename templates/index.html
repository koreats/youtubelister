<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유튜브 영상 텍스트 추출기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Details/Summary 아코디언 화살표 커스텀 */
        summary::marker {
            display: none;
            content: '';
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        .accordion-arrow {
            transition: transform 0.2s ease-in-out;
        }
        details[open] .accordion-arrow {
            transform: rotate(90deg);
        }
        /* 로딩 스피너 */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4 sm:p-6">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-4xl">
        <div class="flex items-center justify-center mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
            <h1 class="text-3xl font-bold text-center text-slate-800">유튜브 영상 텍스트 추출기</h1>
        </div>

        <!-- 입력 폼 -->
        <div class="space-y-4 mb-6">
            <div>
                <label for="channel-input" class="block text-sm font-medium text-slate-700 mb-1">채널 URL 또는 ID</label>
                <input type="text" id="channel-input" class="w-full px-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="채널의 전체 URL 또는 ID를 입력하세요">
            </div>
        </div>

        <!-- 영상 목록 조회 버튼 -->
        <div class="mt-6">
            <button id="fetch-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:bg-indigo-400">
                <span class="btn-text">영상 목록 조회</span>
                <div class="loader hidden ml-3"></div>
            </button>
        </div>
        
        <!-- 상태 메시지가 표시될 컨테이너 -->
        <div id="status-container" class="mt-4 text-center min-h-[24px]"></div>

        <!-- 영상 목록이 표시될 컨테이너 -->
        <div id="video-list-container" class="mt-6 w-full overflow-x-auto"></div>

        <!-- 품질 옵션 선택 -->
        <div id="model-options-container" class="mt-6 hidden">
            <label for="model-select" class="block text-sm font-medium text-slate-700 mb-1">품질/속도 옵션 선택</label>
            <select id="model-select" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="tiny">가장 빠름 (정확도 낮음)</option>
                <option value="base" selected>빠름 (기본)</option>
                <option value="small">중간 (정확도/속도 균형)</option>
                <option value="medium">느림 (정확도 높음)</option>
                <option value="large">가장 느림 (정확도 가장 높음)</option>
            </select>
        </div>

        <!-- 처리 방식 선택 -->
        <div id="mode-options-container" class="mt-4 hidden">
             <label class="block text-sm font-medium text-slate-700 mb-2">처리 방식 선택</label>
             <div class="flex items-center space-x-6">
                <div class="flex items-center">
                    <input id="mode-sequential" name="processing-mode" type="radio" value="sequential" checked class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500">
                    <label for="mode-sequential" class="ml-2 block text-sm text-slate-900">기본 모드 (1개씩 처리)</label>
                </div>
                <div class="flex items-center">
                    <input id="mode-parallel" name="processing-mode" type="radio" value="parallel" class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500">
                    <label for="mode-parallel" class="ml-2 block text-sm text-slate-900">성능 모드 (동시 처리)</label>
                </div>
             </div>
        </div>

        <!-- 텍스트 추출 버튼 -->
        <div class="mt-6">
            <button id="transcribe-btn" class="w-full flex items-center justify-center bg-emerald-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors duration-200 hidden disabled:bg-emerald-400">
                 <span class="btn-text">선택한 영상 텍스트 추출</span>
                 <div class="loader hidden ml-3"></div>
            </button>
        </div>

        <!-- 진행률 표시 UI -->
        <div id="progress-container" class="mt-4 hidden w-full bg-slate-200 rounded-full h-6">
            <div id="progress-bar" class="bg-indigo-600 h-6 text-xs font-medium text-blue-100 text-center p-1 leading-none rounded-full" style="width: 0%">0%</div>
        </div>
        <div id="progress-text" class="text-center text-sm text-slate-600 mt-1"></div>

        <!-- 결과가 표시될 컨테이너 -->
        <div id="results-container" class="mt-6 space-y-3"></div>

    </div>

    <script>
        const channelInput = document.getElementById('channel-input');
        const fetchBtn = document.getElementById('fetch-btn');
        const videoListContainer = document.getElementById('video-list-container');
        const transcribeBtn = document.getElementById('transcribe-btn');
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');
        const modelOptionsContainer = document.getElementById('model-options-container');
        const modelSelect = document.getElementById('model-select');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        let videoData = [];
        let allTranscribedData = [];
        let progressInterval;

        const toggleLoading = (button, isLoading, text) => {
            const btnText = button.querySelector('.btn-text');
            const loader = button.querySelector('.loader');
            if (isLoading) {
                button.disabled = true;
                btnText.textContent = text;
                loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                btnText.textContent = text;
                loader.classList.add('hidden');
            }
        };

        // 1. 영상 목록 조회 기능
        fetchBtn.addEventListener('click', async () => {
            const channelUrl = channelInput.value.trim();
            if (!channelUrl) {
                showStatus('채널 URL을 입력해주세요.', 'error');
                return;
            }

            showStatus('영상 목록을 가져오는 중입니다...', 'loading');
            toggleLoading(fetchBtn, true, '조회 중...');
            videoListContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            transcribeBtn.classList.add('hidden');
            modelOptionsContainer.classList.add('hidden');

            try {
                const response = await fetch('/fetch-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel_url: channelUrl, api_key: "AIzaSyDnKP4KUcareg3DCHMu5T07FsG3KOf-5Dw" })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '알 수 없는 오류가 발생했습니다.');
                
                videoData = data.videos;
                displayVideoTable(videoData);
                showStatus(`총 ${videoData.length}개의 영상을 찾았습니다. (2분 초과 영상)`, 'success');

            } catch (error) {
                showStatus(error.message, 'error');
            } finally {
                toggleLoading(fetchBtn, false, '영상 목록 조회');
            }
        });

        // 2. 텍스트 추출 기능
        transcribeBtn.addEventListener('click', async () => {
            const checkedCheckboxes = document.querySelectorAll('.video-checkbox:checked');
            if (checkedCheckboxes.length === 0) {
                showStatus('텍스트를 추출할 영상을 하나 이상 선택해주세요.', 'error');
                return;
            }

            const videosToTranscribe = Array.from(checkedCheckboxes).map(checkbox => {
                const videoId = checkbox.value;
                return videoData.find(v => v.videoId === videoId);
            });

            const selectedMode = document.querySelector('input[name="processing-mode"]:checked').value;
            const selectedModel = modelSelect.value;

            showStatus(``, 'loading'); // 기존 상태 메시지 클리어
            toggleLoading(transcribeBtn, true, '처리 중...');
            resultsContainer.innerHTML = '';
            progressContainer.classList.remove('hidden');
            updateProgressUI(0, videosToTranscribe.length);

            // 진행 상황 폴링 시작
            progressInterval = setInterval(updateProgress, 1000);

            try {
                const response = await fetch('/transcribe_multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: videosToTranscribe.map(v => v.url), model: selectedModel, mode: selectedMode })
                });
                const results = await response.json();
                if (!response.ok) throw new Error(results.error || '텍스트 추출 중 오류가 발생했습니다.');

                allTranscribedData = results.results.map((result, index) => ({
                    ...result,
                    number: videosToTranscribe[index].number,
                    publishedAt: videosToTranscribe[index].publishedAt
                }));

                displayTranscriptionResults(allTranscribedData);
                showStatus('텍스트 추출이 완료되었습니다.', 'success');

            } catch (error) {
                showStatus(error.message, 'error');
            } finally {
                toggleLoading(transcribeBtn, false, '선택한 영상 텍스트 추출');
                clearInterval(progressInterval); // 폴링 중지
                progressContainer.classList.add('hidden');
                progressText.classList.add('hidden');
            }
        });

        async function updateProgress() {
            try {
                const response = await fetch('/progress');
                const data = await response.json();
                if (data.total > 0) {
                    updateProgressUI(data.current, data.total);
                }
            } catch (error) {
                console.error('Progress update failed:', error);
                clearInterval(progressInterval);
            }
        }

        function updateProgressUI(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            progressText.textContent = `(${current} / ${total})`;
            progressText.classList.remove('hidden');
        }

        function displayVideoTable(videos) {
            if (videos.length === 0) {
                videoListContainer.innerHTML = '<p class="text-center text-slate-500">표시할 영상이 없습니다.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-slate-200';

            table.innerHTML = `
                <thead class="bg-slate-50">
                    <tr>
                        <th scope="col" class="px-3 py-3.5 text-center text-sm font-semibold text-slate-900">
                            <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        </th>
                        <th scope="col" class="w-12 px-3 py-3.5 text-center text-sm font-semibold text-slate-900">No.</th>
                        <th scope="col" class="px-4 py-3.5 text-left text-sm font-semibold text-slate-900">제목</th>
                        <th scope="col" class="px-4 py-3.5 text-left text-sm font-semibold text-slate-900">영상 길이</th>
                        <th scope="col" class="px-4 py-3.5 text-left text-sm font-semibold text-slate-900">업로드일</th>
                        <th scope="col" class="px-4 py-3.5 text-center text-sm font-semibold text-slate-900">동작</th>
                    </tr>
                </thead>
            `;

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-slate-200';

            videos.forEach((video, index) => {
                video.number = index + 1;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50';
                const publishedDate = new Date(video.publishedAt).toISOString().split('T')[0];
                tr.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="video-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${video.videoId}">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-slate-500">${video.number}</td>
                    <td class="px-4 py-4 text-sm font-medium text-slate-900">${video.title}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-slate-500">${video.duration}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-slate-500">${publishedDate}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button class="copy-url-btn text-indigo-600 hover:text-indigo-800 transition-colors" data-url="${video.url}">URL 복사</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            videoListContainer.innerHTML = '';
            videoListContainer.appendChild(table);

            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                document.querySelectorAll('.video-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
            });

            document.querySelectorAll('.copy-url-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const url = e.target.getAttribute('data-url');
                    navigator.clipboard.writeText(url).then(() => {
                        const originalText = e.target.textContent;
                        e.target.textContent = '복사됨!';
                        e.target.classList.add('text-green-500');
                        setTimeout(() => {
                            e.target.textContent = originalText;
                            e.target.classList.remove('text-green-500');
                        }, 2000);
                    });
                });
            });

            transcribeBtn.classList.remove('hidden');
            modelOptionsContainer.classList.remove('hidden');
            document.getElementById('mode-options-container').classList.remove('hidden');
        }

        function displayTranscriptionResults(results) {
            resultsContainer.innerHTML = '';
            if (!results || results.length === 0) return;

            results.forEach(result => {
                const details = document.createElement('details');
                details.className = 'border border-slate-200 rounded-lg mb-3 overflow-hidden';
                
                const summary = document.createElement('summary');
                summary.className = 'p-4 font-medium cursor-pointer hover:bg-slate-50 flex justify-between items-center';
                summary.innerHTML = `
                    <span>${result.number}. ${result.title}</span>
                    <svg class="w-5 h-5 text-slate-500 accordion-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                `;

                const content = document.createElement('div');
                content.className = 'p-4 bg-slate-50 border-t border-slate-200 text-slate-700 whitespace-pre-wrap';
                content.textContent = result.transcript || '추출된 텍스트가 없습니다.';

                details.appendChild(summary);
                details.appendChild(content);
                resultsContainer.appendChild(details);
            });
            
            addResultActionButtons();
        }
        
        function addResultActionButtons() {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3';

            buttonContainer.innerHTML = `
                <button id="copy-markdown-btn" class="w-full flex items-center justify-center bg-slate-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    전체 마크다운 복사
                </button>
                <button id="download-markdown-btn" class="w-full flex items-center justify-center bg-slate-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    전체 다운로드 (.md)
                </button>
            `;
            resultsContainer.appendChild(buttonContainer);

            document.getElementById('copy-markdown-btn').addEventListener('click', copyAllAsMarkdown);
            document.getElementById('download-markdown-btn').addEventListener('click', downloadAllAsMarkdown);
        }

        function generateResultsMarkdown() {
            return allTranscribedData.map(result => {
                const publishedDate = new Date(result.publishedAt).toISOString().split('T')[0];
                return `## ${result.number}. ${result.title}\n**업로드일:** ${publishedDate}\n\n${result.transcript}`;
            }).join('\n\n---\n\n');
        }

        function copyAllAsMarkdown() {
            const markdownContent = generateResultsMarkdown();
            navigator.clipboard.writeText(markdownContent).then(() => {
                showStatus('클립보드에 복사되었습니다.', 'success');
            }, () => {
                showStatus('복사에 실패했습니다.', 'error');
            });
        }

        function downloadAllAsMarkdown() {
            const markdownContent = generateResultsMarkdown();
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcripts.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showStatus(message, type) {
            statusContainer.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = message;
            const colors = {
                error: 'text-red-500',
                success: 'text-green-600',
                loading: 'text-indigo-600'
            };
            p.className = colors[type] || 'text-slate-500';
            statusContainer.appendChild(p);
        }

    </script>
</body>
</html>